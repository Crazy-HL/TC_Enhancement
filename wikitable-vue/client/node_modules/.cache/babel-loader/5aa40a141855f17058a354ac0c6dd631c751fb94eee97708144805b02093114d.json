{"ast":null,"code":"import { createElementVNode as _createElementVNode, toDisplayString as _toDisplayString, openBlock as _openBlock, createElementBlock as _createElementBlock, createCommentVNode as _createCommentVNode, renderList as _renderList, Fragment as _Fragment, normalizeStyle as _normalizeStyle, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from \"vue\";\nconst _withScopeId = n => (_pushScopeId(\"data-v-ec3c90c2\"), n = n(), _popScopeId(), n);\nconst _hoisted_1 = {\n  class: \"word-container\"\n};\nconst _hoisted_2 = {\n  key: 0,\n  class: \"error-message\"\n};\nconst _hoisted_3 = /*#__PURE__*/_withScopeId(() => /*#__PURE__*/_createElementVNode(\"span\", {\n  class: \"error-icon\"\n}, \"⚠️\", -1 /* HOISTED */));\nconst _hoisted_4 = {\n  class: \"error-text\"\n};\nconst _hoisted_5 = [\"title\", \"onClick\"];\nconst _hoisted_6 = {\n  key: 1,\n  class: \"normal-text\"\n};\nconst _hoisted_7 = {\n  key: 0,\n  class: \"loading-indicator\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"span\", _hoisted_1, [$setup.error ? (_openBlock(), _createElementBlock(\"span\", _hoisted_2, [_hoisted_3, _createElementVNode(\"span\", _hoisted_4, \"高频词加载失败: \" + _toDisplayString($setup.error), 1 /* TEXT */), _createElementVNode(\"button\", {\n    onClick: $setup.fetchWordFrequency,\n    class: \"retry-button\"\n  }, \"重试\")])) : (_openBlock(), _createElementBlock(_Fragment, {\n    key: 1\n  }, [(_openBlock(true), _createElementBlock(_Fragment, null, _renderList($setup.segmentedText, (segment, index) => {\n    return _openBlock(), _createElementBlock(_Fragment, {\n      key: index\n    }, [segment.isWord && $setup.isHighlighted(segment.text) ? (_openBlock(), _createElementBlock(\"span\", {\n      key: 0,\n      class: \"frequency-word\",\n      style: _normalizeStyle($setup.getWordStyle(segment.text)),\n      title: `在相关评论中出现 ${$setup.wordFrequency[segment.text] || 0} 次`,\n      onClick: $event => $setup.handleWordClick(segment.text)\n    }, _toDisplayString(segment.text), 13 /* TEXT, STYLE, PROPS */, _hoisted_5)) : (_openBlock(), _createElementBlock(\"span\", _hoisted_6, _toDisplayString(segment.text), 1 /* TEXT */))], 64 /* STABLE_FRAGMENT */);\n  }), 128 /* KEYED_FRAGMENT */)), $setup.isLoading ? (_openBlock(), _createElementBlock(\"span\", _hoisted_7, \"...\")) : _createCommentVNode(\"v-if\", true)], 64 /* STABLE_FRAGMENT */))]);\n}","map":{"version":3,"names":["class","key","_createElementVNode","_createElementBlock","_hoisted_1","$setup","error","_hoisted_2","_hoisted_3","_hoisted_4","_toDisplayString","onClick","fetchWordFrequency","_Fragment","_renderList","segmentedText","segment","index","isWord","isHighlighted","text","style","_normalizeStyle","getWordStyle","title","wordFrequency","$event","handleWordClick","_hoisted_5","_hoisted_6","isLoading","_hoisted_7","_createCommentVNode"],"sources":["D:\\ZhiHu\\zhihu-bullet\\wikitable-vue\\client\\src\\components\\HighFrequencyWords.vue"],"sourcesContent":["<script setup>\r\n\timport { ref, computed, watch, onMounted } from \"vue\";\r\n\timport api from \"@/api\";\r\n\r\n\tconst props = defineProps({\r\n\t\tsentence: {\r\n\t\t\ttype: String,\r\n\t\t\trequired: true\r\n\t\t},\r\n\t\tsentenceIndex: {\r\n\t\t\ttype: Number,\r\n\t\t\trequired: true\r\n\t\t},\r\n\t\tcomments: {\r\n\t\t\ttype: Array,\r\n\t\t\tdefault: () => []\r\n\t\t},\r\n\t\tactive: {\r\n\t\t\ttype: Boolean,\r\n\t\t\tdefault: false\r\n\t\t},\r\n\t\tminFrequency: {\r\n\t\t\ttype: Number,\r\n\t\t\tdefault: 3\r\n\t\t},\r\n\t\tmaxFontSize: {\r\n\t\t\ttype: Number,\r\n\t\t\tdefault: 1.5\r\n\t\t},\r\n\t\tminFontSize: {\r\n\t\t\ttype: Number,\r\n\t\t\tdefault: 1\r\n\t\t},\r\n\t\tcolorRange: {\r\n\t\t\ttype: Array,\r\n\t\t\tdefault: () => [\"#FFD700\", \"#FF6347\"]\r\n\t\t}\r\n\t});\r\n\r\n\tconst emit = defineEmits([\"word-click\"]);\r\n\r\n\t// 数据状态\r\n\tconst wordFrequency = ref({});\r\n\tconst highlightedWords = ref([]);\r\n\tconst segmentedText = ref([]);\r\n\tconst isLoading = ref(false);\r\n\tconst error = ref(null);\r\n\r\n\t// 改进的分词函数\r\n\tconst segmentText = text => {\r\n\t\tif (!text) return [];\r\n\r\n\t\t// 更精确的中文分词正则\r\n\t\tconst regex =\r\n\t\t\t/([\\u4e00-\\u9fa5]{2,4}|[a-zA-Z]{3,}|[\\u4e00-\\u9fa5]|\\p{P}|\\s)/gu;\r\n\t\tconst segments = [];\r\n\t\tlet match;\r\n\r\n\t\twhile ((match = regex.exec(text)) !== null) {\r\n\t\t\tconst token = match[0];\r\n\t\t\tsegments.push({\r\n\t\t\t\ttext: token,\r\n\t\t\t\tisWord: /[\\u4e00-\\u9fa5]{2,}|[a-zA-Z]{3,}/.test(token)\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\treturn segments;\r\n\t};\r\n\r\n\t// 增强的词频获取函数\r\n\tconst fetchWordFrequency = async () => {\r\n\t\tif (!props.active || isLoading.value) return;\r\n\r\n\t\tisLoading.value = true;\r\n\t\terror.value = null;\r\n\r\n\t\ttry {\r\n\t\t\tconst response = await api.post(\"word_frequency\", {\r\n\t\t\t\tsentence_index: props.sentenceIndex,\r\n\t\t\t\tcomments: props.comments\r\n\t\t\t});\r\n\r\n\t\t\t// 统一响应处理\r\n\t\t\tconst responseData = response?.data || response;\r\n\r\n\t\t\tif (!responseData) {\r\n\t\t\t\tthrow new Error(\"Empty response from server\");\r\n\t\t\t}\r\n\r\n\t\t\t// 处理成功响应\r\n\t\t\tif (responseData.status === \"success\") {\r\n\t\t\t\twordFrequency.value = responseData.data?.word_frequency || {};\r\n\t\t\t\tupdateHighlightedWords();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\t// 处理错误响应\r\n\t\t\tif (responseData.status === \"error\") {\r\n\t\t\t\tthrow new Error(responseData.message || \"Server returned error\");\r\n\t\t\t}\r\n\r\n\t\t\t// 兼容旧版无status字段的响应\r\n\t\t\tif (typeof responseData.word_frequency === \"object\") {\r\n\t\t\t\twordFrequency.value = responseData.word_frequency || {};\r\n\t\t\t\tupdateHighlightedWords();\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(\"Invalid response format\");\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(\"Failed to fetch word frequency:\", err);\r\n\t\t\terror.value = err.message || \"Failed to load word frequency\";\r\n\t\t\twordFrequency.value = {};\r\n\t\t} finally {\r\n\t\t\tisLoading.value = false;\r\n\t\t}\r\n\t};\r\n\r\n\t// 更新高亮词汇\r\n\tconst updateHighlightedWords = () => {\r\n\t\thighlightedWords.value = Object.entries(wordFrequency.value)\r\n\t\t\t.filter(([_, count]) => count >= props.minFrequency)\r\n\t\t\t.map(([word]) => word);\r\n\t};\r\n\r\n\t// 改进的高亮判断\r\n\tconst isHighlighted = word => {\r\n\t\treturn (\r\n\t\t\tprops.active &&\r\n\t\t\thighlightedWords.value.some(hw => hw.includes(word) || word.includes(hw))\r\n\t\t);\r\n\t};\r\n\r\n\t// 获取词的样式\r\n\tconst getWordStyle = word => {\r\n\t\tif (!isHighlighted(word)) return {};\r\n\r\n\t\tconst count = wordFrequency.value[word] || 0;\r\n\t\tconst maxCount = Math.max(\r\n\t\t\t...Object.values(wordFrequency.value),\r\n\t\t\tprops.minFrequency\r\n\t\t);\r\n\t\tconst ratio = Math.min(count / maxCount, 1);\r\n\r\n\t\tconst fontSize =\r\n\t\t\tprops.minFontSize + (props.maxFontSize - props.minFontSize) * ratio;\r\n\r\n\t\tconst color = interpolateColor(\r\n\t\t\tprops.colorRange[0],\r\n\t\t\tprops.colorRange[1],\r\n\t\t\tratio\r\n\t\t);\r\n\r\n\t\treturn {\r\n\t\t\tfontSize: `${fontSize}em`,\r\n\t\t\tcolor: color,\r\n\t\t\tfontWeight: 400 + Math.round(ratio * 300),\r\n\t\t\tbackgroundColor: `hsla(30, 80%, 80%, ${ratio * 0.3})`,\r\n\t\t\tpadding: \"0 2px\",\r\n\t\t\tborderRadius: \"3px\",\r\n\t\t\ttransition: \"all 0.2s ease\",\r\n\t\t\tdisplay: \"inline-block\",\r\n\t\t\tlineHeight: \"1.2\",\r\n\t\t\ttextDecoration: \"underline\",\r\n\t\t\ttextUnderlineOffset: \"2px\"\r\n\t\t};\r\n\t};\r\n\r\n\t// 颜色插值函数\r\n\tconst interpolateColor = (color1, color2, factor) => {\r\n\t\tif (!color1 || !color2) return \"#FFD700\";\r\n\r\n\t\tconst hex = color => color.replace(\"#\", \"\");\r\n\t\tconst h2r = hex => parseInt(hex, 16);\r\n\t\tconst r2h = num => Math.round(num).toString(16).padStart(2, \"0\");\r\n\r\n\t\tconst c1 = hex(color1);\r\n\t\tconst c2 = hex(color2);\r\n\r\n\t\tconst r1 = h2r(c1.substring(0, 2));\r\n\t\tconst g1 = h2r(c1.substring(2, 4));\r\n\t\tconst b1 = h2r(c1.substring(4, 6));\r\n\r\n\t\tconst r2 = h2r(c2.substring(0, 2));\r\n\t\tconst g2 = h2r(c2.substring(2, 4));\r\n\t\tconst b2 = h2r(c2.substring(4, 6));\r\n\r\n\t\tconst r = r1 + (r2 - r1) * factor;\r\n\t\tconst g = g1 + (g2 - g1) * factor;\r\n\t\tconst b = b1 + (b2 - b1) * factor;\r\n\r\n\t\treturn `#${r2h(r)}${r2h(g)}${r2h(b)}`;\r\n\t};\r\n\r\n\t// 处理词汇点击\r\n\tconst handleWordClick = word => {\r\n\t\tif (isHighlighted(word)) {\r\n\t\t\temit(\"word-click\", {\r\n\t\t\t\tword: word,\r\n\t\t\t\tfrequency: wordFrequency.value[word] || 0\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\t// 初始化分词\r\n\tonMounted(() => {\r\n\t\tsegmentedText.value = segmentText(props.sentence);\r\n\t});\r\n\r\n\t// 监听属性变化\r\n\twatch(\r\n\t\t() => props.sentence,\r\n\t\tnewVal => {\r\n\t\t\tsegmentedText.value = segmentText(newVal);\r\n\t\t}\r\n\t);\r\n\r\n\twatch(\r\n\t\t() => props.active,\r\n\t\tnewVal => {\r\n\t\t\tif (newVal) {\r\n\t\t\t\tfetchWordFrequency();\r\n\t\t\t} else {\r\n\t\t\t\twordFrequency.value = {};\r\n\t\t\t\thighlightedWords.value = [];\r\n\t\t\t}\r\n\t\t},\r\n\t\t{ immediate: true }\r\n\t);\r\n\r\n\twatch(\r\n\t\t() => props.comments,\r\n\t\t() => {\r\n\t\t\tif (props.active) {\r\n\t\t\t\tfetchWordFrequency();\r\n\t\t\t}\r\n\t\t},\r\n\t\t{ deep: true }\r\n\t);\r\n</script>\r\n\r\n<template>\r\n\t<span class=\"word-container\">\r\n\t\t<template v-if=\"error\" class=\"error-message\">\r\n\t\t\t<span class=\"error-message\">\r\n\t\t\t\t<span class=\"error-icon\">⚠️</span>\r\n\t\t\t\t<span class=\"error-text\">高频词加载失败: {{ error }}</span>\r\n\t\t\t\t<button @click=\"fetchWordFrequency\" class=\"retry-button\">重试</button>\r\n\t\t\t</span>\r\n\t\t</template>\r\n\r\n\t\t<template v-else>\r\n\t\t\t<template v-for=\"(segment, index) in segmentedText\" :key=\"index\">\r\n\t\t\t\t<span\r\n\t\t\t\t\tv-if=\"segment.isWord && isHighlighted(segment.text)\"\r\n\t\t\t\t\tclass=\"frequency-word\"\r\n\t\t\t\t\t:style=\"getWordStyle(segment.text)\"\r\n\t\t\t\t\t:title=\"`在相关评论中出现 ${wordFrequency[segment.text] || 0} 次`\"\r\n\t\t\t\t\t@click=\"handleWordClick(segment.text)\">\r\n\t\t\t\t\t{{ segment.text }}\r\n\t\t\t\t</span>\r\n\t\t\t\t<span v-else class=\"normal-text\">\r\n\t\t\t\t\t{{ segment.text }}\r\n\t\t\t\t</span>\r\n\t\t\t</template>\r\n\r\n\t\t\t<span v-if=\"isLoading\" class=\"loading-indicator\">...</span>\r\n\t\t</template>\r\n\t</span>\r\n</template>\r\n\r\n<style scoped>\r\n\t.word-container {\r\n\t\tdisplay: inline;\r\n\t\tline-height: 1.6;\r\n\t\tposition: relative;\r\n\t}\r\n\r\n\t.frequency-word {\r\n\t\tposition: relative;\r\n\t\tcursor: pointer;\r\n\t\ttransition: all 0.2s ease;\r\n\t}\r\n\r\n\t.frequency-word:hover {\r\n\t\ttransform: translateY(-2px);\r\n\t\tz-index: 2;\r\n\t\tbox-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);\r\n\t}\r\n\r\n\t.normal-text {\r\n\t\tdisplay: inline;\r\n\t}\r\n\r\n\t.loading-indicator {\r\n\t\tdisplay: inline-block;\r\n\t\tmargin-left: 4px;\r\n\t\tcolor: #999;\r\n\t}\r\n\r\n\t.error-message {\r\n\t\tdisplay: inline-flex;\r\n\t\talign-items: center;\r\n\t\tgap: 6px;\r\n\t\tpadding: 4px 8px;\r\n\t\tbackground-color: #fff8f8;\r\n\t\tborder: 1px solid #ffebee;\r\n\t\tborder-radius: 4px;\r\n\t\tfont-size: 0.9em;\r\n\t}\r\n\r\n\t.error-icon {\r\n\t\tcolor: #ff5252;\r\n\t}\r\n\r\n\t.retry-button {\r\n\t\tmargin-left: 8px;\r\n\t\tpadding: 2px 6px;\r\n\t\tbackground: #ffebee;\r\n\t\tborder: none;\r\n\t\tborder-radius: 3px;\r\n\t\tcursor: pointer;\r\n\t\tfont-size: 0.8em;\r\n\t}\r\n\r\n\t.retry-button:hover {\r\n\t\tbackground: #ffcdd2;\r\n\t}\r\n</style>\r\n"],"mappings":";;;EAkPOA,KAAK,EAAC;AAAgB;;EAlP7BC,GAAA;EAoPSD,KAAK,EAAC;;gEACXE,mBAAA,CAAkC;EAA5BF,KAAK,EAAC;AAAY,GAAC,IAAE;;EACrBA,KAAK,EAAC;AAAY;mBAtP5B;;EAAAC,GAAA;EAqQiBD,KAAK,EAAC;;;EArQvBC,GAAA;EA0Q0BD,KAAK,EAAC;;;uBAxB/BG,mBAAA,CA0BO,QA1BPC,UA0BO,GAzBUC,MAAA,CAAAC,KAAK,I,cACpBH,mBAAA,CAIO,QAJPI,UAIO,GAHNC,UAAkC,EAClCN,mBAAA,CAAoD,QAApDO,UAAoD,EAA3B,WAAS,GAAAC,gBAAA,CAAGL,MAAA,CAAAC,KAAK,kBAC1CJ,mBAAA,CAAoE;IAA3DS,OAAK,EAAEN,MAAA,CAAAO,kBAAkB;IAAEZ,KAAK,EAAC;KAAe,IAAE,E,oBAI7DG,mBAAA,CAgBWU,SAAA;IA3QbZ,GAAA;EAAA,K,kBA4PGE,mBAAA,CAYWU,SAAA,QAxQdC,WAAA,CA4PwCT,MAAA,CAAAU,aAAa,EA5PrD,CA4PqBC,OAAO,EAAEC,KAAK;yBA5PnCd,mBAAA,CAAAU,SAAA;MAAAZ,GAAA,EA4P6DgB;IAAK,IAEvDD,OAAO,CAACE,MAAM,IAAIb,MAAA,CAAAc,aAAa,CAACH,OAAO,CAACI,IAAI,K,cADnDjB,mBAAA,CAOO;MApQXF,GAAA;MA+PKD,KAAK,EAAC,gBAAgB;MACrBqB,KAAK,EAhQXC,eAAA,CAgQajB,MAAA,CAAAkB,YAAY,CAACP,OAAO,CAACI,IAAI;MAChCI,KAAK,cAAcnB,MAAA,CAAAoB,aAAa,CAACT,OAAO,CAACI,IAAI;MAC7CT,OAAK,EAAAe,MAAA,IAAErB,MAAA,CAAAsB,eAAe,CAACX,OAAO,CAACI,IAAI;wBACjCJ,OAAO,CAACI,IAAI,gCAnQpBQ,UAAA,M,cAqQIzB,mBAAA,CAEO,QAFP0B,UAEO,EAAAnB,gBAAA,CADHM,OAAO,CAACI,IAAI,kB;kCAILf,MAAA,CAAAyB,SAAS,I,cAArB3B,mBAAA,CAA2D,QAA3D4B,UAA2D,EAAV,KAAG,KA1QvDC,mBAAA,e","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}