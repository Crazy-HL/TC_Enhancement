{"ast":null,"code":"import { createCommentVNode as _createCommentVNode, renderList as _renderList, Fragment as _Fragment, openBlock as _openBlock, createElementBlock as _createElementBlock, toDisplayString as _toDisplayString, normalizeStyle as _normalizeStyle, createElementVNode as _createElementVNode, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from \"vue\";\nconst _withScopeId = n => (_pushScopeId(\"data-v-69ad0d39\"), n = n(), _popScopeId(), n);\nconst _hoisted_1 = {\n  class: \"danmu-container\",\n  ref: \"danmuContainer\"\n};\nconst _hoisted_2 = {\n  class: \"danmu-card-content\"\n};\nconst _hoisted_3 = {\n  class: \"danmu-user\"\n};\nconst _hoisted_4 = [\"src\"];\nconst _hoisted_5 = {\n  class: \"username\"\n};\nconst _hoisted_6 = {\n  class: \"danmu-text\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createCommentVNode(\" 文本样式弹幕 \"), $props.styleType === 'text' ? (_openBlock(true), _createElementBlock(_Fragment, {\n    key: 0\n  }, _renderList($setup.visibleDanmus, danmu => {\n    return _openBlock(), _createElementBlock(\"div\", {\n      key: danmu.id,\n      class: \"danmu-item danmu-text\",\n      style: _normalizeStyle({\n        top: `${danmu.top}px`,\n        'animation-duration': `${danmu.speed}s`,\n        color: danmu.color\n      })\n    }, _toDisplayString(danmu.user) + \"：\" + _toDisplayString(danmu.content), 5 /* TEXT, STYLE */);\n  }), 128 /* KEYED_FRAGMENT */)) : _createCommentVNode(\"v-if\", true), _createCommentVNode(\" 卡片样式弹幕 \"), $props.styleType === 'card' ? (_openBlock(true), _createElementBlock(_Fragment, {\n    key: 1\n  }, _renderList($setup.visibleDanmus, danmu => {\n    return _openBlock(), _createElementBlock(\"div\", {\n      key: danmu.id,\n      class: \"danmu-item danmu-card\",\n      style: _normalizeStyle({\n        top: `${danmu.top}px`,\n        'animation-duration': `${danmu.speed}s`\n      })\n    }, [_createElementVNode(\"div\", _hoisted_2, [_createElementVNode(\"div\", _hoisted_3, [_createElementVNode(\"img\", {\n      src: danmu.avatar,\n      class: \"avatar\"\n    }, null, 8 /* PROPS */, _hoisted_4), _createElementVNode(\"span\", _hoisted_5, _toDisplayString(danmu.user), 1 /* TEXT */)]), _createElementVNode(\"div\", _hoisted_6, _toDisplayString(danmu.content), 1 /* TEXT */)])], 4 /* STYLE */);\n  }), 128 /* KEYED_FRAGMENT */)) : _createCommentVNode(\"v-if\", true)], 512 /* NEED_PATCH */);\n}","map":{"version":3,"names":["class","ref","_createElementBlock","_hoisted_1","_createCommentVNode","$props","styleType","_Fragment","key","_renderList","$setup","visibleDanmus","danmu","id","style","_normalizeStyle","top","speed","color","user","_toDisplayString","content","_createElementVNode","_hoisted_2","_hoisted_3","src","avatar","_hoisted_4","_hoisted_5","_hoisted_6"],"sources":["D:\\ZhiHu\\zhihu-bullet\\wikitable-vue\\client\\src\\components\\DanmuDisplay.vue"],"sourcesContent":["<template>\r\n\t<div class=\"danmu-container\" ref=\"danmuContainer\">\r\n\t\t<!-- 文本样式弹幕 -->\r\n\t\t<div\r\n\t\t\tv-if=\"styleType === 'text'\"\r\n\t\t\tv-for=\"danmu in visibleDanmus\"\r\n\t\t\t:key=\"danmu.id\"\r\n\t\t\tclass=\"danmu-item danmu-text\"\r\n\t\t\t:style=\"{\r\n\t\t\t\ttop: `${danmu.top}px`,\r\n\t\t\t\t'animation-duration': `${danmu.speed}s`,\r\n\t\t\t\tcolor: danmu.color\r\n\t\t\t}\">\r\n\t\t\t{{ danmu.user }}：{{ danmu.content }}\r\n\t\t</div>\r\n\r\n\t\t<!-- 卡片样式弹幕 -->\r\n\t\t<div\r\n\t\t\tv-if=\"styleType === 'card'\"\r\n\t\t\tv-for=\"danmu in visibleDanmus\"\r\n\t\t\t:key=\"danmu.id\"\r\n\t\t\tclass=\"danmu-item danmu-card\"\r\n\t\t\t:style=\"{\r\n\t\t\t\ttop: `${danmu.top}px`,\r\n\t\t\t\t'animation-duration': `${danmu.speed}s`\r\n\t\t\t}\">\r\n\t\t\t<div class=\"danmu-card-content\">\r\n\t\t\t\t<div class=\"danmu-user\">\r\n\t\t\t\t\t<img :src=\"danmu.avatar\" class=\"avatar\" />\r\n\t\t\t\t\t<span class=\"username\">{{ danmu.user }}</span>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div class=\"danmu-text\">{{ danmu.content }}</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</template>\r\n\r\n<script setup>\r\n\timport { ref, computed, watch, onMounted } from \"vue\";\r\n\r\n\tconst props = defineProps({\r\n\t\tcomments: Array,\r\n\t\tactiveSentence: Number,\r\n\t\tmaxLines: {\r\n\t\t\ttype: Number,\r\n\t\t\tdefault: 3\r\n\t\t},\r\n\t\tmaxDanmus: {\r\n\t\t\ttype: Number,\r\n\t\t\tdefault: 5\r\n\t\t},\r\n\t\tbaseSpeed: {\r\n\t\t\ttype: Number,\r\n\t\t\tdefault: 10\r\n\t\t},\r\n\t\tstyleType: {\r\n\t\t\ttype: String,\r\n\t\t\tdefault: \"text\",\r\n\t\t\tvalidator: value => [\"text\", \"card\"].includes(value)\r\n\t\t}\r\n\t});\r\n\r\n\tconst colorPool = [\r\n\t\t\"#FF6B6B\",\r\n\t\t\"#4ECDC4\",\r\n\t\t\"#45B7D1\",\r\n\t\t\"#FFA07A\",\r\n\t\t\"#98D8C8\",\r\n\t\t\"#F06292\",\r\n\t\t\"#7986CB\",\r\n\t\t\"#9575CD\",\r\n\t\t\"#64B5F6\",\r\n\t\t\"#4DB6AC\",\r\n\t\t\"#81C784\",\r\n\t\t\"#FFD54F\"\r\n\t];\r\n\r\n\tconst defaultAvatar =\r\n\t\t\"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI2NjYyIgZD0iTTEyLDJBMTAsMTAgMCAwLDAgMiwxMkExMCwxMCAwIDAsMCAxMiwyMkExMCwxMCAwIDAsMCAyMiwxMkExMCwxMCAwIDAsMCAxMiwyTTEyLDRBNyA3IDAgMCwxIDE5LDExQTcgNyAwIDAsMSAxMiwxOEE3LDcgMCAwLDEgNSwxMUE3LDcgMCAwLDEgMTIsNE0xMiw2QTUsNSAwIDAsMCA3LDExQTUsNSAwIDAsMCAxMiwxNkE1LDUgMCAwLDAgMTcsMTFBNSw1IDAgMCwwIDEyLDZNMTIsOEEzLDMgMCAwLDEgMTUsMTFBNCw0IDAgMCwxIDEyLDE1QTQsNCAwIDAsMSA5LDExQTMsMyAwIDAsMSAxMiw4WiIvPjwvc3ZnPg==\";\r\n\r\n\tconst danmuContainer = ref(null);\r\n\tconst danmuLines = ref([]);\r\n\tconst allDanmus = ref([]);\r\n\r\n\tconst getRandomColor = () => {\r\n\t\treturn colorPool[Math.floor(Math.random() * colorPool.length)];\r\n\t};\r\n\r\n\tconst getCommentsForSentence = sentenceIndex => {\r\n\t\treturn props.comments.filter(comment => comment.link === sentenceIndex);\r\n\t};\r\n\r\n\tconst calculateSpeed = text => {\r\n\t\tconst lengthFactor = Math.min(text.length / 50, 2);\r\n\t\treturn props.baseSpeed + Math.random() * 5 * lengthFactor;\r\n\t};\r\n\r\n\tconst assignDanmuLine = () => {\r\n\t\tconst now = Date.now();\r\n\t\tconst availableLines = [];\r\n\r\n\t\tfor (let i = 0; i < props.maxLines; i++) {\r\n\t\t\tif (!danmuLines.value[i] || danmuLines.value[i] < now) {\r\n\t\t\t\tavailableLines.push(i);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn availableLines.length > 0\r\n\t\t\t? availableLines[Math.floor(Math.random() * availableLines.length)]\r\n\t\t\t: Math.floor(Math.random() * props.maxLines);\r\n\t};\r\n\r\n\tconst generateDanmus = () => {\r\n\t\tif (props.activeSentence === null) return;\r\n\r\n\t\tconst relatedComments = getCommentsForSentence(props.activeSentence);\r\n\t\tif (relatedComments.length === 0) return;\r\n\r\n\t\tconst commentsToShow = relatedComments.slice(0, props.maxDanmus);\r\n\r\n\t\tcommentsToShow.forEach(comment => {\r\n\t\t\tconst lineIndex = assignDanmuLine();\r\n\t\t\tconst speed = calculateSpeed(comment.content);\r\n\r\n\t\t\tdanmuLines.value[lineIndex] = Date.now() + speed * 1000;\r\n\r\n\t\t\tallDanmus.value.push({\r\n\t\t\t\tid: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n\t\t\t\tcontent: comment.content,\r\n\t\t\t\tuser: comment.user_nickname,\r\n\t\t\t\tavatar: comment.user_avatar || defaultAvatar,\r\n\t\t\t\tcolor: getRandomColor(),\r\n\t\t\t\ttop: lineIndex * (props.styleType === \"card\" ? 60 : 30) + 10,\r\n\t\t\t\tspeed: speed,\r\n\t\t\t\tcreateTime: Date.now()\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tconst cleanExpiredDanmus = () => {\r\n\t\tconst now = Date.now();\r\n\t\tallDanmus.value = allDanmus.value.filter(danmu => {\r\n\t\t\treturn now - danmu.createTime < danmu.speed * 1000 * 1.5;\r\n\t\t});\r\n\t};\r\n\r\n\tconst visibleDanmus = computed(() => {\r\n\t\tcleanExpiredDanmus();\r\n\t\treturn allDanmus.value.slice(-props.maxDanmus * 2);\r\n\t});\r\n\r\n\twatch(\r\n\t\t() => props.activeSentence,\r\n\t\tnewVal => {\r\n\t\t\tif (newVal !== null) {\r\n\t\t\t\tgenerateDanmus();\r\n\t\t\t}\r\n\t\t}\r\n\t);\r\n\r\n\twatch(\r\n\t\t() => props.styleType,\r\n\t\t() => {\r\n\t\t\t// 样式切换时重置弹幕位置\r\n\t\t\tallDanmus.value = [];\r\n\t\t\tdanmuLines.value = Array(props.maxLines).fill(0);\r\n\t\t}\r\n\t);\r\n\r\n\tonMounted(() => {\r\n\t\tdanmuLines.value = Array(props.maxLines).fill(0);\r\n\t});\r\n</script>\r\n\r\n<style scoped>\r\n\t.danmu-container {\r\n\t\tposition: fixed;\r\n\t\ttop: 20px;\r\n\t\tleft: 0;\r\n\t\twidth: 100%;\r\n\t\theight: calc(v-bind(\"props.maxLines\") * 60px + 20px);\r\n\t\toverflow: hidden;\r\n\t\tz-index: 100;\r\n\t\tpointer-events: none;\r\n\t}\r\n\r\n\t.danmu-item {\r\n\t\tposition: absolute;\r\n\t\twhite-space: nowrap;\r\n\t\tleft: 100%;\r\n\t\ttransform: translateX(0);\r\n\t\twill-change: transform;\r\n\t\tanimation: danmu-move linear;\r\n\t}\r\n\r\n\t.danmu-text {\r\n\t\tfont-size: 16px;\r\n\t\tpadding: 4px 12px;\r\n\t\tborder-radius: 15px;\r\n\t\tbackground-color: rgba(255, 255, 255, 0.8);\r\n\t\tbox-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);\r\n\t\ttext-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);\r\n\t}\r\n\r\n\t.danmu-card {\r\n\t\twidth: 250px;\r\n\t\tbackground: white;\r\n\t\tborder-radius: 8px;\r\n\t\tbox-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\r\n\t\toverflow: hidden;\r\n\t}\r\n\r\n\t.danmu-card-content {\r\n\t\tpadding: 10px;\r\n\t}\r\n\r\n\t.danmu-user {\r\n\t\tdisplay: flex;\r\n\t\talign-items: center;\r\n\t\tmargin-bottom: 6px;\r\n\t}\r\n\r\n\t.danmu-user .avatar {\r\n\t\twidth: 24px;\r\n\t\theight: 24px;\r\n\t\tborder-radius: 50%;\r\n\t\tmargin-right: 8px;\r\n\t\tobject-fit: cover;\r\n\t}\r\n\r\n\t.danmu-user .username {\r\n\t\tfont-size: 14px;\r\n\t\tfont-weight: bold;\r\n\t\tcolor: #333;\r\n\t}\r\n\r\n\t.danmu-card .danmu-text {\r\n\t\tfont-size: 14px;\r\n\t\tline-height: 1.4;\r\n\t\twhite-space: normal;\r\n\t\tword-break: break-word;\r\n\t\ttext-shadow: none;\r\n\t\tbackground: transparent;\r\n\t\tpadding: 0;\r\n\t}\r\n\r\n\t@keyframes danmu-move {\r\n\t\tto {\r\n\t\t\ttransform: translateX(-100vw);\r\n\t\t}\r\n\t}\r\n</style>\r\n"],"mappings":";;;EACMA,KAAK,EAAC,iBAAiB;EAACC,GAAG,EAAC;;;EAyB1BD,KAAK,EAAC;AAAoB;;EACzBA,KAAK,EAAC;AAAY;mBA3B3B;;EA6BWA,KAAK,EAAC;AAAU;;EAElBA,KAAK,EAAC;AAAY;;uBA9B1BE,mBAAA,CAiCM,OAjCNC,UAiCM,GAhCLC,mBAAA,YAAe,EAERC,MAAA,CAAAC,SAAS,e,kBADhBJ,mBAAA,CAWMK,SAAA;IAdRC,GAAA;EAAA,GAAAC,WAAA,CAKmBC,MAAA,CAAAC,aAAa,EAAtBC,KAAK;yBAFbV,mBAAA,CAWM;MARJM,GAAG,EAAEI,KAAK,CAACC,EAAE;MACdb,KAAK,EAAC,uBAAuB;MAC5Bc,KAAK,EARTC,eAAA;gBAQ0BH,KAAK,CAACI,GAAG;iCAAoCJ,KAAK,CAACK,KAAK;eAAiBL,KAAK,CAACM;;wBAKnGN,KAAK,CAACO,IAAI,IAAG,GAAC,GAAAC,gBAAA,CAAGR,KAAK,CAACS,OAAO;mCAbpCjB,mBAAA,gBAgBEA,mBAAA,YAAe,EAERC,MAAA,CAAAC,SAAS,e,kBADhBJ,mBAAA,CAgBMK,SAAA;IAjCRC,GAAA;EAAA,GAAAC,WAAA,CAmBmBC,MAAA,CAAAC,aAAa,EAAtBC,KAAK;yBAFbV,mBAAA,CAgBM;MAbJM,GAAG,EAAEI,KAAK,CAACC,EAAE;MACdb,KAAK,EAAC,uBAAuB;MAC5Bc,KAAK,EAtBTC,eAAA;gBAsB0BH,KAAK,CAACI,GAAG;iCAAoCJ,KAAK,CAACK,KAAK;;QAI/EK,mBAAA,CAMM,OANNC,UAMM,GALLD,mBAAA,CAGM,OAHNE,UAGM,GAFLF,mBAAA,CAA0C;MAApCG,GAAG,EAAEb,KAAK,CAACc,MAAM;MAAE1B,KAAK,EAAC;4BA5BpC2B,UAAA,GA6BKL,mBAAA,CAA8C,QAA9CM,UAA8C,EAAAR,gBAAA,CAApBR,KAAK,CAACO,IAAI,iB,GAErCG,mBAAA,CAAiD,OAAjDO,UAAiD,EAAAT,gBAAA,CAAtBR,KAAK,CAACS,OAAO,iB;mCA/B5CjB,mBAAA,e","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}